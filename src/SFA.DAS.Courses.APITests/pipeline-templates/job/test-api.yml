parameters:
  Environment:
  ServiceConnection:

jobs:
- deployment: RunAcceptanceTests
  pool:
    vmImage: 'windows-latest'
  environment: TEST_SUITE
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: self
        - task: ExtractFiles@1
          displayName: 'Extract files '
          inputs:
            archiveFilePatterns: '$(Pipeline.Workspace)/**/tests.zip'
            destinationFolder: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/tests'
        - task: esfadevops.Tokenization.custom-build-task.Tokenization@0
          displayName: 'Tokenization: Transform file *.json'
          inputs:
            SourcePath: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/tests'
            TargetFileNames: '*.json'
        - task: PowerShell@2
          displayName: 'Update NumberOfTestWorkers'
          inputs:
            targetType: filePath
            filePath: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/src/UpdateNoofTestWorkers.ps1'
            arguments: '-browser local'
        - task: esfadevops.Tokenization.custom-build-task.Tokenization@0
          displayName: 'Tokenization: Transform file *.runsettings'
          inputs:
            SourcePath: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/runsettings/src/'
            TargetFileNames: '*.runsettings'
        - ${{ if eq(parameters['Environment'], 'PP') }}:    
          - template: azure-pipelines-templates/deploy/step/appservice-whitelist-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(CoursesApiAppServiceName)
              RuleName: "CoursesApiAcceptanceTests"
        - task: VSTest@2
          displayName: 'VsTest - Test Execution '
          inputs:
            testAssemblyVer2: '**/SFA.DAS.Courses.APITests.dll'
            searchFolder: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/tests/SFA.DAS.Courses.APITests/'
            testFiltercriteria: '$(TestCategory)'
            runSettingsFile: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/runsettings/src/Parellel.runsettings'
            runInParallel: true
            otherConsoleOptions: '/logger:trx'
            rerunFailedTests: true
            rerunFailedThreshold: 100
            rerunMaxAttempts: 2
          continueOnError: true
        - task: PowerShell@2
          displayName: 'Check .trx File Exists'
          inputs:
            targetType: filePath
            filePath: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/src/Check-TestResults.ps1'
            arguments: '-SourcePath "$(Agent.TempDirectory)/TestResults"'
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-remove-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(CoursesApiAppServiceName)