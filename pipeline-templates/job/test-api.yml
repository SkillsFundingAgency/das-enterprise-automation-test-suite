parameters:
  Environment:
  ServiceConnection:
  TestFilter:
  TestDlls:

jobs:
- deployment: RunAcceptanceTests
  pool:
    vmImage: 'windows-latest'
  environment: TEST_SUITE
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: self
        - checkout: das-platform-automation
        - task: FileTransform@1
          displayName: 'Tokenization: Transform file *.json'
          inputs:
            FolderPath: '$(Pipeline.Workspace)/**/tests.zip'
            FileType: json
        - task: ExtractFiles@1
          displayName: 'Extract files'
          inputs:
            archiveFilePatterns: '$(Pipeline.Workspace)/**/tests.zip'
            destinationFolder: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/tests'
        - template: azure-pipelines-templates/deploy/step/sql-whitelist-ip.yml@das-platform-building-blocks
          parameters:
            ServiceConnection: ${{ parameters.ServiceConnection }}
            SQLServerName: $(SharedSQLServerName)
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-whitelist-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(ApprenticeAccountsAppServiceName)
              RuleName: ${{ replace(variables['Build.DefinitionName'], '-automation-test-suite', '') }}
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-whitelist-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(ApprenticeCommitmentsOuterApiAppServiceName)
              RuleName: ${{ replace(variables['Build.DefinitionName'], '-automation-test-suite', '') }}
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-whitelist-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(CoursesAppServiceName)
              RuleName: ${{ replace(variables['Build.DefinitionName'], '-automation-test-suite', '') }}
        - task: DotNetCoreCLI@2
          env:
            ResourceEnvironmentName: $(ResourceEnvironmentName)
          inputs:
            command: 'test'
            arguments: '--filter "${{ parameters.TestFilter }}" --logger trx;logfilename=${{ parameters.Environment }}_testResults.trx'
            projects: |
              ${{ parameters.TestDlls }}
        - task: PowerShell@2
          displayName: 'Check .trx File Exists'
          inputs:
            targetType: filePath
            filePath: '$(Pipeline.Workspace)/das-enterprise-automation-test-suite/drop/src/Check-TestResults.ps1'
            arguments: '-SourcePath "$(Agent.TempDirectory)"'
        - template: azure-pipelines-templates/deploy/step/sql-remove-ip.yml@das-platform-building-blocks
          parameters:
            ServiceConnection: ${{ parameters.ServiceConnection }}
            SQLServerName: $(SharedSQLServerName)
            IPAddress: $(IPAddress)
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-remove-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(ApprenticeAccountsAppServiceName)
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-remove-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(ApprenticeCommitmentsOuterApiAppServiceName)
        - ${{ if eq(parameters['Environment'], 'PP') }}:
          - template: azure-pipelines-templates/deploy/step/appservice-remove-ip.yml@das-platform-building-blocks
            parameters:
              ServiceConnection: ${{ parameters.ServiceConnection }}
              ResourceName: $(CoursesAppServiceName)